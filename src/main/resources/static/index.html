<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chatSection { display: none; margin-top: 20px; }
        #messages { list-style: none; padding: 0; }
        #messages li { padding: 5px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
<h2>Chat Demo</h2>

<div id="joinSection">
    <h3>Join Room</h3>
    <input id="roomId" placeholder="Room ID" />
    <input id="email" placeholder="Your email" />
    <button onclick="joinRoom()">Join</button>
</div>

<div id="chatSection">
    <h3>Room: <span id="currentRoom"></span></h3>
    <button onclick="leaveRoom()">Leave Room</button>
    <button onclick="exitRoom()">Exit Room</button>
    <br><br>

    <input id="msg" placeholder="Type message..." />
    <button onclick="sendMessage()">Send</button>

    <ul id="messages"></ul>
</div>

<script>
    let stompClient = null;
    let roomId = null;
    let email = null;
    let subscription = null;

    function connectWS(callback) {
        if (!stompClient) {
            const socket = new SockJS("http://localhost:8080/ws");
            stompClient = Stomp.over(socket);

            stompClient.connect({}, callback, (error) => {
                alert("Connection error: " + error);
            });
        } else {
            callback();
        }
    }

    function joinRoom() {
        roomId = document.getElementById("roomId").value;
        email = document.getElementById("email").value;

        connectWS(() => {
            // Subscribe to room topic
            subscription = stompClient.subscribe("/topic/room/" + roomId, (messageOutput) => {
                const msg = JSON.parse(messageOutput.body);
                const li = document.createElement("li");
                li.innerText = `${msg.sender?.name || "System"}: ${msg.message}`;
                document.getElementById("messages").appendChild(li);
            });

            // Tell backend I joined
            stompClient.send("/app/chat.join", {}, JSON.stringify({
                roomId: roomId,
                email: email
            }));

            document.getElementById("joinSection").style.display = "none";
            document.getElementById("chatSection").style.display = "block";
            document.getElementById("currentRoom").innerText = roomId;
        });
    }

    function leaveRoom() {
        // Notify backend
        stompClient.send("/app/chat.leave", {}, JSON.stringify({
            roomId: roomId,
            email: email
        }));

        // Then exit locally
        exitRoom();
    }

    function exitRoom() {
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
        }
        // Keep connection alive for other rooms
        document.getElementById("joinSection").style.display = "block";
        document.getElementById("chatSection").style.display = "none";
        document.getElementById("messages").innerHTML = "";
        document.getElementById("roomId").value = "";
        document.getElementById("currentRoom").innerText = "";
    }

    function sendMessage() {
        const msg = document.getElementById("msg").value;
        if (!msg) return;

        stompClient.send("/app/chat.message", {}, JSON.stringify({
            roomId: roomId,
            email: email,
            message: msg
        }));

        document.getElementById("msg").value = "";
    }
</script>
</body>
</html>
